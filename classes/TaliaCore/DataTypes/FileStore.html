<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: TaliaCore::DataTypes::FileStore</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">TaliaCore::DataTypes::FileStore</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/lib/talia_core/data_types/file_store_rb.html">
                lib/talia_core/data_types/file_store.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
The &quot;hevy lifting&quot; for FileRecords, handling the actual creation
and manipulation of the files.
</p>
<p>
A record can be created with <a
href="FileStore.html#M000145">create_from_file</a> (passing a filename) or
with <a href="FileStore.html#M000146">create_from_data</a>, passing a byte
array.
</p>
<p>
While a &quot;location&quot; can be passed to the record (which will be
save in the database), the actual file name will be determined by the
system. Also see the <a href="PathHelpers.html">PathHelpers</a> for info
</p>
<p>
The base directory for file storage can be configured in the talia_core.yml
file as &quot;data_directory_location&quot;. Otherwise, RAILS_ROOT/data.
Inside, each record will be stored at &quot;&lt;data class of the
record&gt;/&lt;last three numbers of the id&gt;/&lt;record id&gt;&quot;
</p>
<p>
So, for example, a &quot;<a href="XmlData.html">XmlData</a>&quot; record
with the id &quot;123456&quot; would be stored as &quot;DATA_ROOT/<a
href="XmlData.html">XmlData</a>/456/123456&quot;
</p>
<h1>Creating new records</h1>
<p>
When creating a new record using <a
href="FileStore.html#M000146">create_from_data</a>, the data will be cached
inside the object and only be saved when the record itself is saved. In
this case, the file data is simply written to file during the save
operation.
</p>
<p>
When the record is created using <a
href="FileStore.html#M000145">create_from_file</a>, the behaviour depens on
the parameters passed and the system settings.
</p>
<ul>
<li>In case the delete_original flag is set, the system will try to move the
file to the new location. If both are on the same file system, this will be
quicker than a copy operation.

</li>
<li>Currently, the move operation uses the &quot;mv&quot; command. This is does
not work on windows, but is a workaround to stability problems with the
file handling in JRuby

</li>
<li>If the delete_original flag is not set, the system will attempt to copy the
files:

<ul>
<li>If the &quot;delay_file_copies&quot; options is set in the
<em>environment</em>, no copy operation will be done. Instead, the system
will create a &quot;delayed_copies.sh&quot; script that can be executed
from a UNIX shell to do the actual copying. This is extremely fast and
stable, as no actual copying is done.

</li>
<li>Otherwise Talia will attempt to copy the file by itself. If the
&quot;fast_copies&quot; flag is set in <em>environment</em>, it will use
the internal copy routine which will work on any system. Otherwise, it will
call the system&#8216;s &quot;cp&quot; command, which can sometimes be more
stable with jruby.

</li>
</ul>
</li>
</ul>
<p>
Also see the <a href="DataLoader.html">DataLoader</a> module to see how the
creation of records automatically selects the record type and loader,
depending on the MIME type of the data.
</p>
<p>
<b>Note</b>: The above behaviour means that for files that are treated
through &quot;copy&quot; or &quot;move&quot;, the original file must not be
touched by external processes until the record is saved
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000147">all_text</a>&nbsp;&nbsp;
      <a href="#M000150">assign_type</a>&nbsp;&nbsp;
      <a href="#M000146">create_from_data</a>&nbsp;&nbsp;
      <a href="#M000145">create_from_file</a>&nbsp;&nbsp;
      <a href="#M000149">is_file_open?</a>&nbsp;&nbsp;
      <a href="#M000148">write_file_after_save</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">

    <div id="class-list">
      <h3 class="section-bar">Classes and Modules</h3>

      Class <a href="FileStore/DataPath.html" class="link">TaliaCore::DataTypes::FileStore::DataPath</a><br />

    </div>




      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000147" class="method-detail">
        <a name="M000147"></a>

        <div class="method-heading">
          <a href="#M000147" class="method-signature">
          <span class="method-name">all_text</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the contents of the file as a text string.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000147-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000147-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_core/data_types/file_store.rb, line 97</span>
 97:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">all_text</span>
 98:         <span class="ruby-keyword kw">if</span>(<span class="ruby-operator">!</span><span class="ruby-identifier">is_file_open?</span>)
 99:           <span class="ruby-identifier">open_file</span>
100:         <span class="ruby-keyword kw">end</span>
101:         <span class="ruby-ivar">@file_handle</span>.<span class="ruby-identifier">read</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">size</span>)
102:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000150" class="method-detail">
        <a name="M000150"></a>

        <div class="method-heading">
          <a href="#M000150" class="method-signature">
          <span class="method-name">assign_type</span><span class="method-args">(content_type)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Assign the STI subclass, perfoming a mime-type lookup.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000150-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000150-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_core/data_types/file_store.rb, line 137</span>
137:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">assign_type</span>(<span class="ruby-identifier">content_type</span>)
138:         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">type</span> = <span class="ruby-constant">MimeMapping</span>.<span class="ruby-identifier">class_type_from</span>(<span class="ruby-identifier">content_type</span>).<span class="ruby-identifier">name</span>
139:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000146" class="method-detail">
        <a name="M000146"></a>

        <div class="method-heading">
          <a href="#M000146" class="method-signature">
          <span class="method-name">create_from_data</span><span class="method-args">(location, data, options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Creates a new record from the given data (binary array). See the module
documentation for the details; the data will be cached and written to disk
once the new record is saved.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000146-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000146-source">
<pre>
    <span class="ruby-comment cmt"># File lib/talia_core/data_types/file_store.rb, line 81</span>
81:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_from_data</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">data</span>, <span class="ruby-identifier">options</span> = {})
82:         <span class="ruby-comment cmt"># close file if opened</span>
83:         <span class="ruby-identifier">close_file</span>
84:     
85:         <span class="ruby-comment cmt"># Set the location for the record</span>
86:         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">location</span> = <span class="ruby-identifier">location</span>
87:     
88:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">data</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:read</span>))
89:           <span class="ruby-ivar">@file_data_to_write</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">read</span>
90:         <span class="ruby-keyword kw">else</span>
91:           <span class="ruby-ivar">@file_data_to_write</span> = <span class="ruby-identifier">data</span>
92:         <span class="ruby-keyword kw">end</span>
93:     
94:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000145" class="method-detail">
        <a name="M000145"></a>

        <div class="method-heading">
          <a href="#M000145" class="method-signature">
          <span class="method-name">create_from_file</span><span class="method-args">(location, file_path, delete_original = false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Creates a new record from an existing file on the file system. The file
will be copied or moved when the new record is saved - see the module
documentation to see how this works in detail.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000145-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000145-source">
<pre>
    <span class="ruby-comment cmt"># File lib/talia_core/data_types/file_store.rb, line 71</span>
71:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_from_file</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">file_path</span>, <span class="ruby-identifier">delete_original</span> = <span class="ruby-keyword kw">false</span>)
72:         <span class="ruby-identifier">close_file</span>
73:         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">location</span> = <span class="ruby-identifier">location</span>
74:         <span class="ruby-ivar">@file_data_to_write</span> = <span class="ruby-constant">DataPath</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">file_path</span>)
75:         <span class="ruby-ivar">@delete_original_file</span> = <span class="ruby-identifier">delete_original</span>
76:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000149" class="method-detail">
        <a name="M000149"></a>

        <div class="method-heading">
          <a href="#M000149" class="method-signature">
          <span class="method-name">is_file_open?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return true if the data file is open
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000149-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000149-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_core/data_types/file_store.rb, line 131</span>
131:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_file_open?</span>
132:         (<span class="ruby-ivar">@file_handle</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword kw">nil</span>)
133:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000148" class="method-detail">
        <a name="M000148"></a>

        <div class="method-heading">
          <a href="#M000148" class="method-signature">
          <span class="method-name">write_file_after_save</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Callback for writing the data from <a
href="FileStore.html#M000146">create_from_data</a> or <a
href="FileStore.html#M000145">create_from_file</a>. If there is a problem
saving this file, only an internal assertion is thrown so that it
won&#8216;t crash production environments.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000148-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000148-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_core/data_types/file_store.rb, line 107</span>
107:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">write_file_after_save</span> 
108:         <span class="ruby-comment cmt"># check if there are data to write</span>
109:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span>(<span class="ruby-ivar">@file_data_to_write</span>)
110:     
111:         <span class="ruby-keyword kw">begin</span>
112:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">benchmark</span>(<span class="ruby-node">&quot;\033[36m\033[1m\033[4mFileStore\033[0m Saving file for #{self.id}&quot;</span>) <span class="ruby-keyword kw">do</span>
113:             <span class="ruby-comment cmt"># create data directory path</span>
114:             <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-identifier">data_directory</span>)
115:     
116:             <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@file_data_to_write</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">DataPath</span>))
117:               <span class="ruby-identifier">copy_data_file</span>
118:             <span class="ruby-keyword kw">else</span>
119:               <span class="ruby-identifier">save_cached_data</span>
120:             <span class="ruby-keyword kw">end</span>
121:           
122:             <span class="ruby-ivar">@file_data_to_write</span> = <span class="ruby-keyword kw">nil</span>
123:           <span class="ruby-keyword kw">end</span>
124:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
125:           <span class="ruby-identifier">assit_fail</span>(<span class="ruby-node">&quot;Exception on writing file #{self.location}: #{e}&quot;</span>)
126:         <span class="ruby-keyword kw">end</span>
127: 
128:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>