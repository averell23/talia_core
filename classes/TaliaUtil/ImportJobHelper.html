<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: TaliaUtil::ImportJobHelper</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">TaliaUtil::ImportJobHelper</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../files/lib/talia_util/import_job_helper_rb.html">
                lib/talia_util/import_job_helper.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="../Object.html">
                Object
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
Helper methods that will be used during import job runs. The import jobs
may use the following environment parameters:
</p>
<dl>
<dt><b>base_url</b></dt><dd>The base URL or directory. This will be prefixed to all urls, or if it is a
local directory, it will be made the current directory during the import

</dd>
<dt><b>index</b></dt><dd>If given, the importer will try to read this document. While this will
still support the old-style &quot;hyper&quot; format with sigla, it should
usually contain a main element called &quot;index&quot; followed by
&quot;url&quot; entries.

</dd>
<dt><b>xml</b></dt><dd>URL of an XML file to import. This is incompatible with the
&quot;index&quot; option. If neither &quot;xml&quot; nor &quot;index&quot;
are given, the class will try to read the XML data from STDIN

</dd>
<dt><b>importer</b></dt><dd>Name of the importer class to be used for the data. Uses the default class
if not given

</dd>
<dt><b>reset_store</b></dt><dd>- If this is set, the data store will be cleared before the import

</dd>
<dt><b>user</b></dt><dd>Username for HTTP authentication, if required

</dd>
<dt><b>pass</b></dt><dd>Password for HTTP authentication, if required

</dd>
<dt><b>callback</b></dt><dd>Name of a class. If given, the import will call the before_import and
after_import methods on an object of that class. The call will receive a
block which may be yielded to for each progress step and which can receive
the overall number of steps

</dd>
<dt><b>extension</b></dt><dd>Only used with index files; file extension to use

</dd>
<dt><b>duplicates</b></dt><dd>How to deal with elements that already exist in the datastore. This may be
set to one of the following options (default: :skip):

<ul>
<li>:add - Database fields will be updated and the system will add semantic
properties as additional values, without removing any of the existing
semantic relations. Example: If the data store already contains a title for
an element, and the import file contains another for that element, the
element will have two titles after the import. The system will not check
for duplicates. Files will always be imported in addition to the existing
ones.

</li>
<li>:update - Database fields will be updated, and semantic properties will be
overwritten with the <a href="ImportJobHelper.html#M000445">new</a>
value(s). Semantic properties that are not included in the import data will
be left untouched. In the example above, the element would only contain the
<a href="ImportJobHelper.html#M000445">new</a> title. If the element also
contained author information, and no author information was in the import
file, the existing author information will be untouched. Existing files are
replaced if the import contains <a
href="ImportJobHelper.html#M000445">new</a> files

</li>
<li>:overwrite - Database fields will be updated. All semantic data will be
deleted before the import. Files are always removed.

</li>
<li>:skip - If an element already exists, the import will be skipped.

</li>
</ul>
</dd>
<dt><b>trace</b></dt><dd>Enable tracing output for errors. (By default, this takes the rake
task&#8216;s setting if possible)

</dd>
</dl>
<p>
The import itself consists in calling initialize and the <a
href="ImportJobHelper.html#M000447">do_import</a>
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000447">do_import</a>&nbsp;&nbsp;
      <a href="#M000449">import_from_index</a>&nbsp;&nbsp;
      <a href="#M000446">init_data</a>&nbsp;&nbsp;
      <a href="#M000450">make_url_from</a>&nbsp;&nbsp;
      <a href="#M000445">new</a>&nbsp;&nbsp;
      <a href="#M000448">print_error</a>&nbsp;&nbsp;
      <a href="#M000451">run_callback</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->
    <div id="includes">
      <h3 class="section-bar">Included Modules</h3>

      <div id="includes-list">
        <span class="include-name"><a href="IoHelper.html">IoHelper</a></span>
      </div>
    </div>

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">base_url</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">callback</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">credentials</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">duplicates</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">importer</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">index_data</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">message_stream</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">progressor</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">reset</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">trace</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">xml_data</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000445" class="method-detail">
        <a name="M000445"></a>

        <div class="method-heading">
          <a href="#M000445" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(message_stream = STDOUT, progressor = TaliaUtil::BarProgressor)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
The message_stream will be used for printing progress messages.
</p>
<p>
The procedure of the import is the following:
</p>
<ul>
<li>Set up all the attributes of this class from the respective environment
variables (from the rake task)

</li>
<li>Initialize the data: If an index file is given, read the index file.
Otherwise read the file given by the &#8216;xml&#8217; environment
variable, or from STDIN if &#8216;xml&#8217; isn&#8216;t set. See <a
href="ImportJobHelper.html#M000446">init_data</a>

</li>
<li>Create the callback class, if given

</li>
<li>Set up the progressor for the import, if any

</li>
</ul>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000445-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000445-source">
<pre>
    <span class="ruby-comment cmt"># File lib/talia_util/import_job_helper.rb, line 65</span>
65:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">message_stream</span> = <span class="ruby-constant">STDOUT</span>, <span class="ruby-identifier">progressor</span> = <span class="ruby-constant">TaliaUtil</span><span class="ruby-operator">::</span><span class="ruby-constant">BarProgressor</span>)
66:       <span class="ruby-ivar">@trace</span> = (<span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">Rake</span>) <span class="ruby-operator">?</span> <span class="ruby-constant">Rake</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">options</span>.<span class="ruby-identifier">trace</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">false</span>) <span class="ruby-operator">||</span> <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'trace'</span>]
67:       <span class="ruby-ivar">@progressor</span> = <span class="ruby-identifier">progressor</span>
68:       <span class="ruby-ivar">@message_stream</span> = <span class="ruby-identifier">message_stream</span>
69:       <span class="ruby-ivar">@duplicates</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'duplicates'</span>].<span class="ruby-identifier">to_sym</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-constant">ENV</span>[<span class="ruby-value str">'duplicates'</span>])
70:       <span class="ruby-ivar">@importer</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'importer'</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">'TaliaCore::ActiveSourceParts::Xml::SourceReader'</span>
71:       <span class="ruby-ivar">@credentials</span> = { <span class="ruby-identifier">:http_basic_authentication</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-constant">ENV</span>[<span class="ruby-value str">'user'</span>], <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'pass'</span>]] } <span class="ruby-keyword kw">unless</span>(<span class="ruby-constant">ENV</span>[<span class="ruby-value str">'user'</span>].<span class="ruby-identifier">blank?</span>)
72:       <span class="ruby-identifier">assit</span>(<span class="ruby-operator">!</span>(<span class="ruby-constant">ENV</span>[<span class="ruby-value str">'xml'</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'index'</span>]), <span class="ruby-value str">'Not both xml and index parameters allowed'</span>)
73:       <span class="ruby-ivar">@reset</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'reset_store'</span>].<span class="ruby-identifier">yes?</span>
74: 
75:       <span class="ruby-ivar">@base_url</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'base_url'</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-value">? </span><span class="ruby-value str">''</span> <span class="ruby-operator">:</span> <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'base_url'</span>]
76:       <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">base_url</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">directory?</span>(<span class="ruby-identifier">base_url</span>))
77:         <span class="ruby-identifier">message_stream</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Setting directory to #{base_url}&quot;</span>
78:         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">cd</span>(<span class="ruby-identifier">base_url</span>)
79:       <span class="ruby-keyword kw">end</span>
80: 
81:       <span class="ruby-identifier">init_data</span>
82:       
83:       <span class="ruby-ivar">@callback</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'callback'</span>].<span class="ruby-identifier">classify</span>.<span class="ruby-identifier">constantize</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">unless</span>(<span class="ruby-constant">ENV</span>[<span class="ruby-value str">'callback'</span>].<span class="ruby-identifier">blank?</span>)
84:       
85:       <span class="ruby-identifier">message_stream</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Registered callback (#{callback.class.name}) - (#{callback.respond_to?(:before_import)}|#{callback.respond_to?(:after_import)})&quot;</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">callback</span>)
86:       
87:       <span class="ruby-identifier">callback</span>.<span class="ruby-identifier">progressor</span> = <span class="ruby-identifier">progressor</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">callback</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">callback</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value str">'progressor='</span><span class="ruby-value str">'progressor='</span>))
88:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000447" class="method-detail">
        <a name="M000447"></a>

        <div class="method-heading">
          <a href="#M000447" class="method-signature">
          <span class="method-name">do_import</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Does the actual importing:
</p>
<ul>
<li>If required, reset the data store

</li>
<li>Run the &quot;before_import&quot; callback

</li>
<li>In case there is plain xml data, TaliaCore::ActiveSource.create_from_xml
will handle all the import

</li>
<li>If an index is given, the import will be done by <a
href="ImportJobHelper.html#M000449">import_from_index</a>

</li>
<li>Run the &quot;after_import&quot; callback

</li>
</ul>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000447-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000447-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/import_job_helper.rb, line 118</span>
118:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">do_import</span>
119:       <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">reset</span>)
120:         <span class="ruby-constant">TaliaUtil</span><span class="ruby-operator">::</span><span class="ruby-constant">Util</span>.<span class="ruby-identifier">full_reset</span>
121:         <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Data Store has been completely reset&quot;</span>
122:       <span class="ruby-keyword kw">end</span>
123:       <span class="ruby-identifier">errors</span> = []
124:       <span class="ruby-identifier">run_callback</span>(<span class="ruby-identifier">:before_import</span>)
125:       <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">index_data</span>)
126:         <span class="ruby-identifier">import_from_index</span>(<span class="ruby-identifier">errors</span>)
127:       <span class="ruby-keyword kw">else</span>
128:         <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Importing from single data file.&quot;</span>
129:         <span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ActiveSource</span>.<span class="ruby-identifier">create_from_xml</span>(<span class="ruby-identifier">xml_data</span>, <span class="ruby-identifier">:progressor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">progressor</span>, <span class="ruby-identifier">:reader</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">importer</span>, <span class="ruby-identifier">:base_file_uri</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@true_root</span>, <span class="ruby-identifier">:errors</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">errors</span>, <span class="ruby-identifier">:duplicates</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">duplicates</span>)
130:       <span class="ruby-keyword kw">end</span>
131:       <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>)
132:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;WARNING: #{errors.size} errors during import:&quot;</span>
133:         <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">e</span><span class="ruby-operator">|</span> <span class="ruby-identifier">print_error</span> <span class="ruby-identifier">e</span> }
134:       <span class="ruby-keyword kw">end</span>
135:       <span class="ruby-identifier">run_callback</span>(<span class="ruby-identifier">:after_import</span>)
136:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000449" class="method-detail">
        <a name="M000449"></a>

        <div class="method-heading">
          <a href="#M000449" class="method-signature">
          <span class="method-name">import_from_index</span><span class="method-args">(errors)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This is <b>only</b> used if an index file is given for the import. All
&quot;plain&quot; imports go directly to create_from_xml in the
ActiveSource class
</p>
<ul>
<li>The index file is parsed as XML

</li>
<li>If the root element is &quot;sigla&quot;, the old hyper format is used

</li>
<li>In case the hyper format is used, sigla (local names for URIs) are expected
as &quot;siglum&quot; elements. Otherwise, the import URIs are expected in
&quot;url&quot; tags.

</li>
<li>For each import url, sources_from_url is called on the selected importer,
and the attributes added to the import data

</li>
<li>The result is passed to TaliaCore::ActiveSource.create_multi from to create
the sources

</li>
</ul>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000449-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000449-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/import_job_helper.rb, line 157</span>
157:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">import_from_index</span>(<span class="ruby-identifier">errors</span>)
158:       <span class="ruby-identifier">doc</span> = <span class="ruby-constant">Hpricot</span>.<span class="ruby-constant">XML</span>(<span class="ruby-identifier">index_data</span>)
159:       <span class="ruby-identifier">hyper_format</span> = (<span class="ruby-identifier">doc</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'sigla'</span>)
160:       <span class="ruby-identifier">elements</span> = <span class="ruby-identifier">hyper_format</span> <span class="ruby-value">? </span>(<span class="ruby-identifier">doc</span><span class="ruby-operator">/</span><span class="ruby-identifier">:siglum</span>) <span class="ruby-operator">:</span> (<span class="ruby-identifier">doc</span><span class="ruby-operator">/</span><span class="ruby-identifier">:url</span>)
161:       <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Import from Index file, #{elements.size} elements&quot;</span>
162:       <span class="ruby-comment cmt"># Read the Attributes from the urls</span>
163:       <span class="ruby-identifier">source_attributes</span> = []
164:       <span class="ruby-identifier">my_importer</span> = <span class="ruby-identifier">importer</span>.<span class="ruby-identifier">classify</span>.<span class="ruby-identifier">constantize</span>
165:       <span class="ruby-identifier">progressor</span>.<span class="ruby-identifier">run_with_progress</span>(<span class="ruby-value str">'Reading w/ index'</span>, <span class="ruby-identifier">elements</span>.<span class="ruby-identifier">size</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">prog</span><span class="ruby-operator">|</span>
166:         <span class="ruby-identifier">elements</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">element</span><span class="ruby-operator">|</span>
167:           <span class="ruby-identifier">url</span> = <span class="ruby-identifier">make_url_from</span>(<span class="ruby-node">&quot;#{element.inner_text}#{ENV['extension']}&quot;</span>)
168:           <span class="ruby-keyword kw">begin</span>
169:             <span class="ruby-identifier">this_attribs</span> = <span class="ruby-identifier">my_importer</span>.<span class="ruby-identifier">sources_from_url</span>(<span class="ruby-identifier">url</span>, <span class="ruby-identifier">credentials</span>)
170:             <span class="ruby-identifier">source_attributes</span> = <span class="ruby-identifier">source_attributes</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">this_attribs</span>
171:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
172:             <span class="ruby-identifier">message_stream</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Problem importing #{url} (#{e.message})&quot;</span>
173:             <span class="ruby-identifier">message_stream</span>.<span class="ruby-identifier">puts</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>
174:           <span class="ruby-keyword kw">end</span>
175:           <span class="ruby-identifier">prog</span>.<span class="ruby-identifier">inc</span>
176:         <span class="ruby-keyword kw">end</span>
177:       <span class="ruby-keyword kw">end</span>
178:       <span class="ruby-comment cmt"># Write the data</span>
179:       <span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ActiveSource</span>.<span class="ruby-identifier">progressor</span> = <span class="ruby-identifier">progressor</span>
180:       <span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ActiveSource</span>.<span class="ruby-identifier">create_multi_from</span>(<span class="ruby-identifier">source_attributes</span>, <span class="ruby-identifier">:errors</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">errors</span>, <span class="ruby-identifier">:duplicates</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">duplicates</span>)
181:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000446" class="method-detail">
        <a name="M000446"></a>

        <div class="method-heading">
          <a href="#M000446" class="method-signature">
          <span class="method-name">init_data</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Reads the data for the coming import. If the &#8216;index&#8217; parameter
is found in the environment, this will be used as the file name for the
index file, which will be read into the object. Otherwise, if the
&#8216;xml&#8217; environment variable is set, this will will be read and
used as the XML data for the import
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000446-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000446-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/import_job_helper.rb, line 94</span>
 94:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">init_data</span>
 95:       <span class="ruby-keyword kw">if</span>(<span class="ruby-constant">ENV</span>[<span class="ruby-value str">'index'</span>].<span class="ruby-identifier">blank?</span>)
 96:         <span class="ruby-ivar">@xml_data</span> = <span class="ruby-keyword kw">if</span>(<span class="ruby-constant">ENV</span>[<span class="ruby-value str">'xml'</span>].<span class="ruby-identifier">blank?</span>)
 97:           <span class="ruby-constant">STDIN</span>.<span class="ruby-identifier">read</span>
 98:         <span class="ruby-keyword kw">else</span>
 99:           <span class="ruby-identifier">xml_url</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'xml'</span>]
100:           <span class="ruby-identifier">xml_url</span> = <span class="ruby-identifier">base_url</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">xml_url</span> <span class="ruby-keyword kw">unless</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">xml_url</span>))
101:           <span class="ruby-ivar">@true_root</span> = <span class="ruby-identifier">base_for</span>(<span class="ruby-identifier">xml_url</span>)
102:           <span class="ruby-identifier">open_generic</span>(<span class="ruby-identifier">xml_url</span>, <span class="ruby-identifier">credentials</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">read</span> }
103:         <span class="ruby-keyword kw">end</span>
104:       <span class="ruby-keyword kw">else</span>
105:         <span class="ruby-identifier">index</span> = <span class="ruby-identifier">make_url_from</span>(<span class="ruby-constant">ENV</span>[<span class="ruby-value str">'index'</span>])
106:         <span class="ruby-ivar">@index_data</span> = <span class="ruby-identifier">open_generic</span>(<span class="ruby-identifier">index</span>, <span class="ruby-identifier">credentials</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">read</span> }
107:       <span class="ruby-keyword kw">end</span>
108:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000450" class="method-detail">
        <a name="M000450"></a>

        <div class="method-heading">
          <a href="#M000450" class="method-signature">
          <span class="method-name">make_url_from</span><span class="method-args">(url)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000450-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000450-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/import_job_helper.rb, line 183</span>
183:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">make_url_from</span>(<span class="ruby-identifier">url</span>)
184:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">url</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">url</span>))
185:       <span class="ruby-node">&quot;#{base_url}#{url}&quot;</span>
186:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000448" class="method-detail">
        <a name="M000448"></a>

        <div class="method-heading">
          <a href="#M000448" class="method-signature">
          <span class="method-name">print_error</span><span class="method-args">(e)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Prints the message and, if the &quot;trace&quot; option is set, also the
stack trace of the Exception e
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000448-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000448-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/import_job_helper.rb, line 140</span>
140:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">print_error</span>(<span class="ruby-identifier">e</span>)
141:       <span class="ruby-identifier">puts</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
142:       <span class="ruby-identifier">puts</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">trace</span>)
143:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000451" class="method-detail">
        <a name="M000451"></a>

        <div class="method-heading">
          <a href="#M000451" class="method-signature">
          <span class="method-name">run_callback</span><span class="method-args">(name)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000451-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000451-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/import_job_helper.rb, line 188</span>
188:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">run_callback</span>(<span class="ruby-identifier">name</span>)
189:       <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">callback</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">callback</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">name</span>))
190:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Running callback #{name}&quot;</span>
191:         <span class="ruby-identifier">callback</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">name</span>)
192:       <span class="ruby-keyword kw">end</span>
193:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>