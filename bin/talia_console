#!/usr/bin/env ruby
# -*- Ruby -*-

# Talia console start script
# This first initializes talia and the starts IRB

# Helper for local requires
def local_requires
  require "talia_console"
  require "talia_core"
  require "talia_util"
end

begin
  local_requires
rescue LoadError
  puts "Talia gem does not seem to be installed, trying fallback locations."
  lib_path_local = File.join(".", "lib")
  lib_path_rails = File.join(".", "vendor", "plugins", "talia_core", "lib")
  if(FileTest.exists?(File.join(lib_path_local, "talia_console.rb")))
    puts "...seems to be the local talia directory. Using local config."
    $: << lib_path_local
    local_requires
  elsif(FileTest.exists?(File.join(lib_path_rails, "talia_console.rb")))
    puts "... seems to be a rails installation with talia. Using Rails config."
    $: << lib_path_rails
    local_requires
  else
    puts "No Talia installation found. Try to run this within the Talia root dir."
    raise LoadError, "Talia installation not found."
  end
end

# Foreign modules
require "irb"
require "rake"

include TaliaUtil
title

puts "\nEnter <chelp> for help on the Talia-specific commands."
puts ""

flags = TaliaCommands::flags

unless(flags.noinit?)
  init_talia
  talia_config if(flags.verbose?)
else
  puts "Talia not initialized, as requested."
end

if __FILE__ == $0
  IRB.start(__FILE__)
else
  # check -e option
  if /^-e$/ =~ $0
    IRB.start(__FILE__)
  else
    IRB.setup(__FILE__)
  end
end